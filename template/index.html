<!DOCTYPE html>
<html lang="en">
    {% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'new4.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <title>Chatapp</title>
</head>
<body>
    <div class="container">
        <div class="main">
            <div class="user-list">
                <div class="user-logout">
                    <a href="{% url 'logout' %}" id="logout"><button>Logout</button></a>
                </div>
                {% for user in users%}
                <div id="users" value="{{user.id}}" onclick="websocket('{{user.id}}')">
                    <img src="{% static 'simple-flat-isolated-people-icon-free-vector.jpg' %}" alt="" width="40px" height="40px">
                    <div value="{{user.id}}">{{ user.username }}</div>
                </div>
                {% endfor %}
            </div>
            <div class="chat-box" id="togg">
               
            </div>
        </div>
    </div>
    <script>
       
        function websocket(receiver_id){

            const chatsocket=new WebSocket('ws://'+window.location.host+'/ws/chatroom/'+receiver_id+'/')

          
            chatsocket.onopen=()=>{
                
                fetch('http://127.0.0.1:8000/chatroom/'+receiver_id+'/',{
                            method: 'GET',
                        })
                        .then(res=>res.json())
                        .then(data=>{
                            const msg=data.message
                            
                            let chat=document.getElementById('togg')
                            let chatbox=`<div class="chatroom">\
                                                    <div class="profile">\
                                                        <a href='{% url 'index' %}' id="back"><i class="fa-solid fa-arrow-left fa-lg" style="color: #04070c;"></i></a>
                                                        <img src="{% static 'simple-flat-isolated-people-icon-free-vector.jpg' %}" alt="" width="40px" height="40px">\                                     
                                                        ${data.receiver_name}\
                                                    </div>\
                                                    <div class="message">\
                                                        <table class="table">\
                                                            <tbody id='chat-body'>\
                                                                ${msg.map(item=>`
                                                                    ${ item.sender_id == data.sender ?
                                                                        `<tr id="sender">
                                                                            <td >
                                                                                <p style="float: right;">
                                                                                    ${ item.message }
                                                                                    <small>
                                                                                        
                                                                                    </small>
                                                                                </p>
                                                                            
                                                                            </td>
                                                                        </tr>`
                                                                    :
                                                                        `<tr id="receiver">
                                                                            <td >
                                                                                <p style="float: left;">
                                                                                    <small>
                                                                                        {{message.timestamp|time:'H:i'}}
                                                                                    </small>
                                                                                ${ item.message }
                                                                                </p>
                                                                            </td>
                                                                        
                                                                        </tr>`
                                                                    }`
                                                                
                                                                    )}
        
                                                            </tbody>\
                                                        </table>\
                                                    </div>\
                                                    <div class="post-box">\
                                                        <div>\
                                                            <input type="text" name="msg" id="input" placeholder="Enter Your Message">\
                                                            <input type='text' id="sender_id" value='${data.sender}' hidden>
                                                            <input type='text' id="receiver_id" value='${data.receiver_id}' hidden>

                                                        </div>\
                                                        <div>\
                                                            <button id="send-btn"><i class="fa-solid fa-paper-plane" style="color: white;"></i></button>\
                                                        </div>\
                                                    </div>\
                                                </div>`
                            chat.innerHTML=chatbox



                             //send input message to the websocket
                            let input=document.getElementById('input')
                            let btn=document.getElementById('send-btn')

                            btn.addEventListener('click',(e)=>{
                                e.preventDefault();
                                const input_message=input.value

                                chatsocket.send(JSON.stringify({
                                    'message':input_message,
                                    'sender': data.sender,
                                    'receiver':receiver_id
                                }))

                                input.value=''
                                input.focus()
                            })
                            input.focus()

                            

                            
                            const backbtn=document.getElementById('back')
                            backbtn.addEventListener("click",function (e){
                                // chatsocket.close()
                                console.log('window changed')
                            })
                        })

                
            }
            chatsocket.onclose=()=>{
                 console.log("websocket onclose")
             }

             //when message occure in websocket to display the message
             
             chatsocket.onmessage=(e)=>{
                 const time=new Date()
                 const hours=time.getHours()
                 const minute=time.getMinutes()
                 const data=JSON.parse(e.data)
                 console.log(data)
                 console.log(data.sender,data.receiver,data.message)
                 let sender_id=document.getElementById('sender_id')
                 let receiver=document.getElementById('receiver_id')
                if (receiver.getAttribute('value')==receiver_id){
                    if( data.sender == sender_id.getAttribute('value') ){
                        document.querySelector('#chat-body').innerHTML += `<tr id="sender">
                                                                        <td>
                                                                        <p>${data.message}<small>
                                                                        </small></p>
                                                                        
                                                                        </td>
                                                                    </tr>`
                    }else{
                        document.querySelector('#chat-body').innerHTML += `<tr id="receiver">
                                                                                <td>
                                                                                <p style="float:left"><small>
                                                                        </small>${data.message}</p>
                                                                                </td>
                                                                            </tr>`
                    }
                }
                

                 scrolldown();
             }  
             
        }
        function scrolldown(){
            const scrollElement=document.querySelector('.message')
            scrollElement.scrollTop=scrollElement.scrollHeight
        }
        
        

    </script>
</body>
</html>