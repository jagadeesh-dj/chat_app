<!DOCTYPE html>
<html lang="en">
    {% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{% static 'new7.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <title>Chatapp</title>
</head>
<body>
    <div class="container">
        <div class="main">
            <div class="user-list" id="user-list">
                <div class="user-logout">
                    <a href="{% url 'logout' %}" id="logout"><button>Logout</button></a>
                </div>
                {% for user in users%}
                <div id="users"  value="{{user.id}}" onclick="websocket('{{user.id}}')">
                    <img src="{% static 'simple-flat-isolated-people-icon-free-vector.jpg' %}" alt="" width="40px" height="40px">
                    <div value="{{user.id}}">{{ user.username }}</div>
                </div>
                {% endfor %}
            </div>
            <div class="chat-box" id="togg">
            </div>
        </div>
    </div>
    <script>
        let chatsocket=null;
        function websocket(receiver_id){

            if (chatsocket){
                chatsocket.close()
            }

            chatsocket=new WebSocket('ws://192.168.87.205:8000/ws/chatroom/'+receiver_id+'/')
            
          
            chatsocket.onopen=(async ()=>{
                
                fetch('http://192.168.87.205:8000/chatroom/'+receiver_id+'/',{
                            method: 'GET',
                        })
                        .then(res=>res.json())
                        .then(data=>{
                            const msg=data.message
                            
                            let chat=document.getElementById('togg')
                            let chatbox=`<div class="chatroom">
                                                    <div class="profile">
                                                        <a href='{% url 'index' %}' id="back"><i class="fa-solid fa-arrow-left fa-lg" style="color: #04070c;"></i></a>
                                                        <img src="{% static 'simple-flat-isolated-people-icon-free-vector.jpg' %}" alt="" width="40px" height="40px">                                     
                                                        ${data.receiver_name}
                                                    </div>
                                                    <div class="message">
                                                        <table class="table">
                                                            <tbody id='chat-body'>
                                                                ${msg.map(item=>`
                                                                    ${ item.sender_id == data.sender ?
                                                                        `<tr id="sender">
                                                                            <td >
                                                                                <p style="float: right;">
                                                                                    ${ item.message }
                                                                                    <small>
                                                                                        
                                                                                    </small>
                                                                                </p>
                                                                            
                                                                            </td>
                                                                        </tr>`
                                                                    :
                                                                        `<tr id="receiver">
                                                                            <td >
                                                                                <p style="float: left;">
                                                                                    <small>
                                                                                    </small>
                                                                                ${ item.message }
                                                                                </p>
                                                                            </td>
                                                                        
                                                                        </tr>`
                                                                    }`
                                                                
                                                                    )}
        
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <div class="post-box">
                                                        <div>
                                                            <textarea  id="input" name="msg" rows="3" cols="40" placeholder="Enter Your Message"></textarea>

                                                            <input type='text' id="sender_id" value='${data.sender}' hidden>
                                                            <input type='text' id="receiver_id" value='${data.receiver_id}' hidden>
                                                        </div>
                                                        <div>
                                                            <button id="send-btn"><i class="fa-solid fa-paper-plane" style="color: white;"></i></button>\
                                                        </div>
                                                    </div>
                                                </div>`
                            chat.innerHTML=chatbox



                             //send input message to the websocket
                            let input=document.getElementById('input')
                            let btn=document.getElementById('send-btn')

                            btn.addEventListener('click',(e)=>{
                                e.preventDefault();
                                const input_message=input.value

                                chatsocket.send(JSON.stringify({
                                    'message':input_message,
                                    'sender': data.sender,
                                    'receiver':receiver_id
                                }))

                                input.value=''
                                input.focus()
                            })

                            

                            
                            const backbtn=document.getElementById('back')
                            backbtn.addEventListener("click",function (e){
                                // chatsocket.close()
                                console.log('window changed')
                            })
                            
                            const active_users=document.querySelectorAll('#users')
                            active_users.forEach(ele=>{
                                ele.addEventListener('click',(e)=>{
                                    console.log(e.target.getAttribute('value'))
                                })
                            })
                          
                           
                        })

                
            })();
            chatsocket.onclose=()=>{
                 console.log("websocket onclose")
             }

             //when message occure in websocket to display the message
             
             chatsocket.onmessage=(e)=>{
                 const time=new Date()
                 const hours=time.getHours()
                 const minute=time.getMinutes()
                 const data=JSON.parse(e.data)
                 console.log(data)
                 console.log(data.sender,data.receiver,data.message)
                 let sender_id=document.getElementById('sender_id')
                 let receiver=document.getElementById('receiver_id')
                if (receiver.getAttribute('value')==receiver_id){
                    if( data.sender == sender_id.getAttribute('value') ){
                        document.querySelector('#chat-body').innerHTML += `<tr id="sender">
                                                                        <td>
                                                                        <p>${data.message}<small>
                                                                        </small></p>
                                                                        
                                                                        </td>
                                                                    </tr>`
                    }else{
                        document.querySelector('#chat-body').innerHTML += `<tr id="receiver">
                                                                                <td>
                                                                                <p style="float:left"><small>
                                                                        </small>${data.message}</p>
                                                                                </td>
                                                                            </tr>`
                    }
                }
                scrolldown();
             }  
             
        }
        function scrolldown(){
            const scrollElement=document.querySelector('.message')
            scrollElement.scrollTop=scrollElement.scrollHeight
        }
  
        const body=document.querySelector('body')
        if (body.clientWidth<=500){
            const active_users=document.querySelectorAll('#users')
            active_users.forEach(ele=>{
                ele.addEventListener('click',(e)=>{
                    document.querySelector('.chat-box').style.display="block"
                    document.querySelector('.chat-box').style.width="100%"
                    document.querySelector('.chat-box').style.flex="none"

                    document.getElementById('user-list').style.display="none"


                })
            })
        }
        
    

    </script>
</body>
</html>